<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Blackjack Multiplayer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Poppins', sans-serif;
            background-color: #1a2a3a;
            color: #f0f0f0;
            overflow: hidden;
        }
        .view { display: none; }
        .view.active { display: flex; }

        /* Card Styles */
        .card {
            width: 80px;
            height: 112px;
            border-radius: 8px;
            font-size: 18px;
            position: relative;
            transform-style: preserve-3d;
            transition: transform 0.6s, margin-left 0.3s ease;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        }
        .card.red { color: #d92d2d; }
        .card .suit { font-size: 16px; }
        .card-face {
            position: absolute;
            width: 100%; height: 100%;
            backface-visibility: hidden;
            border-radius: 8px;
        }
        .card-back {
            background: linear-gradient(135deg, #1e3a8a 25%, transparent 25%) -40px 0, linear-gradient(225deg, #1e3a8a 25%, transparent 25%) -40px 0, linear-gradient(315deg, #1e3a8a 25%, transparent 25%), linear-gradient(45deg, #1e3a8a 25%, transparent 25%);
            background-size: 80px 80px;
            background-color: #2b4f9a;
            border: 4px solid white;
        }
        .card-front {
            transform: rotateY(180deg);
            background-color: #f8fafc;
            color: black;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            padding: 8px;
        }
        .card.flipped { transform: rotateY(180deg); }

        /* Game Board & Player Area Styles */
        .game-board { background: radial-gradient(circle, #2a4a6e 0%, #1a2a3a 100%); }
        .player-hand { display: flex; min-height: 120px; align-items: center; justify-content: center; }
        .player-hand .card { margin-left: -40px; }
        .player-hand .card:first-child { margin-left: 0; }
        
        .multiplayer-area {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
            width: 100%;
            max-width: 900px;
        }

        .player-box {
            background-color: rgba(0,0,0,0.2);
            padding: 12px;
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            text-align: center;
            transition: all 0.3s ease;
        }
        .player-box.active-turn {
            border-color: #3b82f6;
            box-shadow: 0 0 20px rgba(59, 130, 246, 0.5);
        }

        /* Chip Styles */
        .chip {
            width: 50px; height: 50px;
            border-radius: 50%;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 12px;
            border: 3px solid #fff;
            box-shadow: 0 2px 6px rgba(0,0,0,0.4);
            transition: all 0.2s ease;
        }
        .chip:hover:not(:disabled) { transform: translateY(-3px); }
        .chip:disabled { opacity: 0.4; cursor: not-allowed; }
        .chip-50 { background-color: #ef4444; border-color: #fca5a5; }
        .chip-100 { background-color: #2563eb; border-color: #93c5fd; }
        .chip-250 { background-color: #16a34a; border-color: #86efac; }
        .chip-500 { background-color: #9333ea; border-color: #d8b4fe; }
        .chip-1000 { background-color: #f97316; border-color: #fdba74; }

        /* General UI */
        .btn {
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }
         .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .modal-content { background-color: #2d3748; }
        .toast {
            position: fixed;
            bottom: -100px;
            left: 50%;
            transform: translateX(-50%);
            background-color: #2d3748;
            color: white;
            padding: 1rem 2rem;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.4);
            transition: bottom 0.5s ease-in-out;
            z-index: 200;
        }
        .toast.show {
            bottom: 20px;
        }
    </style>
</head>
<body class="w-screen h-screen">

    <!-- =========== VIEWS =========== -->
    <div id="main-menu-view" class="view active w-full h-full flex-col items-center justify-center game-board">
        <h1 class="text-6xl font-bold mb-12 text-white" style="text-shadow: 2px 2px 8px rgba(0,0,0,0.5);">Blackjack</h1>
        <div class="space-y-6">
            <button id="single-player-btn" class="btn bg-blue-600 text-white w-64 h-16 text-2xl hover:bg-blue-700">Single Player</button>
            <button id="multiplayer-btn" class="btn bg-purple-600 text-white w-64 h-16 text-2xl hover:bg-purple-700">Multiplayer</button>
        </div>
        <div class="absolute bottom-4 text-xs text-gray-400">Loading user data...</div>
    </div>
    
    <div id="multiplayer-menu-view" class="view w-full h-full flex-col items-center justify-center p-8 game-board">
        <h2 class="text-4xl font-bold mb-8">Multiplayer</h2>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-8 w-full max-w-4xl">
            <!-- Left Panel: Friends & Invites -->
            <div class="bg-gray-800/50 p-6 rounded-lg">
                <h3 class="text-2xl font-semibold mb-4">Friends</h3>
                <div class="mb-4">
                    <p class="mb-2">Your ID (Click to copy):</p>
                    <input id="user-id-display" type="text" readonly class="w-full bg-gray-900 cursor-pointer p-2 rounded border border-gray-600" value="Loading...">
                </div>
                <div class="mb-4">
                     <div class="flex gap-2">
                        <input id="add-friend-input" type="text" class="w-full bg-gray-700 p-2 rounded" placeholder="Enter Friend's ID">
                        <button id="add-friend-btn" class="btn bg-green-600 text-white">Add</button>
                    </div>
                </div>
                <div id="friend-requests" class="space-y-2 mb-4"></div>
                <div id="friends-list" class="space-y-2 h-48 overflow-y-auto"></div>
            </div>
            <!-- Right Panel: Game Lobbies -->
            <div class="bg-gray-800/50 p-6 rounded-lg">
                <h3 class="text-2xl font-semibold mb-4">Join a Game</h3>
                <button id="create-game-btn" class="btn bg-blue-600 text-white w-full mb-4">Create New Game</button>
                <div id="public-lobbies" class="space-y-2 h-72 overflow-y-auto"></div>
            </div>
        </div>
        <button id="back-to-main-menu-btn" class="btn bg-gray-600 text-white mt-8">Back to Main Menu</button>
    </div>

    <div id="game-view" class="view w-full h-full flex-col items-center justify-center p-4 game-board relative">
         <!-- Game Info -->
        <div class="absolute top-4 left-4 text-left">
            <p>Game ID: <span id="game-id-display" class="font-mono"></span></p>
            <p>Balance: <span id="player-balance-display" class="font-semibold text-green-400"></span></p>
        </div>
        <button id="leave-game-btn" class="btn bg-red-700 text-white absolute top-4 right-4">Leave Game</button>
        
        <!-- Dealer -->
        <div class="w-full max-w-2xl text-center mb-4">
            <h2 class="text-2xl font-semibold">Dealer's Hand <span id="dealer-score-display" class="font-bold"></span></h2>
            <div id="dealer-cards-display" class="player-hand"></div>
        </div>

        <!-- Players -->
        <div class="multiplayer-area mb-4">
            <!-- Player boxes will be generated here -->
        </div>

        <!-- Betting & Actions -->
        <div id="betting-controls" class="text-center my-2">
            <h3 class="text-xl font-semibold mb-2">Place Your Bet: $<span id="current-bet-display">0</span></h3>
            <div id="chip-container" class="flex justify-center items-center gap-2">
                <button class="chip chip-50" data-value="50">$50</button>
                <button class="chip chip-100" data-value="100">$100</button>
                <button class="chip chip-250" data-value="250">$250</button>
                <button class="chip chip-500" data-value="500">$500</button>
                <button class="chip chip-1000" data-value="1000">$1000</button>
            </div>
        </div>
        <div id="action-controls" class="flex gap-4 my-2">
            <button id="hit-btn" class="btn bg-blue-600 text-white text-lg">Hit</button>
            <button id="stand-btn" class="btn bg-red-600 text-white text-lg">Stand</button>
        </div>
        <div id="game-status-display" class="text-3xl font-bold h-10 mt-2"></div>
    </div>
    
    <!-- Toast Notification -->
    <div id="toast-notification" class="toast"></div>

    <!-- This is a placeholder for the single-player game, which can be re-integrated later -->
    <div id="single-player-game-view"></div> 

    <script type="module">
        // --- Firebase Imports ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc, onSnapshot, collection, query, where, deleteDoc, writeBatch, serverTimestamp, getDocs, onDisconnect } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- MOCK FIREBASE CONFIG (WILL BE REPLACED IN THE ENVIRONMENT) ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'blackjack-app';
        const firebaseConfig = typeof __firebase_config !== 'undefined' 
            ? JSON.parse(__firebase_config) 
            : { apiKey: "AIza...", authDomain: "...", projectId: "..." };
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : undefined;

        // --- App Initialization ---
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // --- Global State ---
        let currentUser = null;
        let currentGameId = null;
        let unsubscribeGameListener = null;
        let unsubscribeLobbiesListener = null;
        let unsubscribeFriendsListener = null;
        let unsubscribeFriendRequestsListener = null;

        // --- DOM Elements ---
        const views = document.querySelectorAll('.view');
        const multiplayerBtn = document.getElementById('multiplayer-btn');
        const backToMainMenuBtn = document.getElementById('back-to-main-menu-btn');
        const userIdDisplay = document.getElementById('user-id-display');
        const addFriendInput = document.getElementById('add-friend-input');
        const addFriendBtn = document.getElementById('add-friend-btn');
        const friendRequestsContainer = document.getElementById('friend-requests');
        const friendsListContainer = document.getElementById('friends-list');
        const createGameBtn = document.getElementById('create-game-btn');
        const publicLobbiesContainer = document.getElementById('public-lobbies');
        const leaveGameBtn = document.getElementById('leave-game-btn');
        
        // --- Utility Functions ---
        const showView = (viewId) => {
            views.forEach(v => v.classList.remove('active'));
            document.getElementById(viewId).classList.add('active');
        };

        const showToast = (message, duration = 3000) => {
            const toast = document.getElementById('toast-notification');
            toast.textContent = message;
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), duration);
        };

        // --- Authentication & User Presence ---
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                userIdDisplay.value = currentUser.uid;

                const userDocRef = doc(db, `users/${currentUser.uid}`);
                const userDoc = await getDoc(userDocRef);

                if (!userDoc.exists()) {
                    await setDoc(userDocRef, {
                        username: `Player_${currentUser.uid.substring(0, 5)}`,
                        createdAt: serverTimestamp(),
                    });
                }
                
                // Presence System
                const presenceRef = doc(db, `presence/${currentUser.uid}`);
                await setDoc(presenceRef, { isOnline: true, lastSeen: serverTimestamp() });
                onDisconnect(presenceRef).set({ isOnline: false, lastSeen: serverTimestamp() });
                
                // Now that user is ready, enable buttons
                multiplayerBtn.disabled = false;
                document.querySelector('.absolute.bottom-4').textContent = `Logged in as ${currentUser.uid.substring(0,8)}`;

            } else {
                 // Try to sign in if not authenticated
                try {
                    if (initialAuthToken) {
                        await signInWithCustomToken(auth, initialAuthToken);
                    } else {
                        await signInAnonymously(auth);
                    }
                } catch (error) {
                    console.error("Authentication failed:", error);
                    document.querySelector('.absolute.bottom-4').textContent = `Authentication Failed.`;
                }
            }
        });

        // --- Navigation ---
        multiplayerBtn.addEventListener('click', () => {
            showView('multiplayer-menu-view');
            listenForPublicLobbies();
            listenForFriendRequests();
            listenForFriends();
        });
        backToMainMenuBtn.addEventListener('click', () => {
            if (unsubscribeLobbiesListener) unsubscribeLobbiesListener();
            if (unsubscribeFriendsListener) unsubscribeFriendsListener();
            if (unsubscribeFriendRequestsListener) unsubscribeFriendRequestsListener();
            showView('main-menu-view');
        });
        
        // --- Friend System Logic ---
        userIdDisplay.addEventListener('click', () => {
            navigator.clipboard.writeText(currentUser.uid)
                .then(() => showToast('User ID copied to clipboard!'))
                .catch(err => console.error('Failed to copy text: ', err));
        });

        addFriendBtn.addEventListener('click', async () => {
            const friendId = addFriendInput.value.trim();
            if (!friendId || friendId === currentUser.uid) return;
            // Simplified: Directly add friends for this example. A real app needs requests.
            const friendRef = doc(db, `users/${currentUser.uid}/friends/${friendId}`);
            const myFriendRef = doc(db, `users/${friendId}/friends/${currentUser.uid}`);
            const friendUserDoc = await getDoc(doc(db, `users/${friendId}`));
            if(!friendUserDoc.exists()) {
                showToast("User ID not found.");
                return;
            }
            await setDoc(friendRef, { username: friendUserDoc.data().username || `Player_${friendId.substring(0,5)}`});
            await setDoc(myFriendRef, { username: `Player_${currentUser.uid.substring(0,5)}`}); // Use current user's name
            showToast("Friend added!");
            addFriendInput.value = '';
        });

        function listenForFriends() {
            if (unsubscribeFriendsListener) unsubscribeFriendsListener();
            const friendsQuery = collection(db, `users/${currentUser.uid}/friends`);
            unsubscribeFriendsListener = onSnapshot(friendsQuery, async (snapshot) => {
                let friendHtml = '<h4 class="font-semibold text-lg">Your Friends:</h4>';
                if (snapshot.empty) {
                    friendHtml += '<p class="text-gray-400">No friends yet. Add one above!</p>';
                } else {
                    for (const friendDoc of snapshot.docs) {
                        const friendId = friendDoc.id;
                        const friendData = friendDoc.data();
                        const presenceDoc = await getDoc(doc(db, `presence/${friendId}`));
                        const isOnline = presenceDoc.exists() && presenceDoc.data().isOnline;
                        friendHtml += `
                            <div class="flex justify-between items-center bg-gray-700 p-2 rounded">
                                <span>${friendData.username}</span>
                                <div class="flex items-center gap-2">
                                    <span class="text-xs ${isOnline ? 'text-green-400' : 'text-gray-500'}">${isOnline ? 'Online' : 'Offline'}</span>
                                    <button class="btn text-xs bg-blue-600 text-white" ${!isOnline ? 'disabled' : ''}>Invite</button>
                                </div>
                            </div>
                        `;
                    }
                }
                friendsListContainer.innerHTML = friendHtml;
            });
        }
        
        // --- Lobby & Game Management ---
        createGameBtn.addEventListener('click', async () => {
            const gameRef = doc(collection(db, 'games'));
            currentGameId = gameRef.id;

            const newGame = {
                hostId: currentUser.uid,
                status: 'lobby', // 'lobby', 'in-progress', 'finished'
                createdAt: serverTimestamp(),
                players: {
                    [currentUser.uid]: {
                        username: `Player_${currentUser.uid.substring(0,5)}`,
                        balance: 2500,
                        hand: [],
                        score: 0,
                        bet: 0,
                        status: 'betting' // betting, playing, stood, bust
                    }
                },
                dealer: { hand: [], score: 0, revealed: false },
                deck: [],
                currentPlayerTurn: null,
                gameMessage: 'Waiting for players...'
            };
            await setDoc(gameRef, newGame);
            joinGame(currentGameId);
        });

        function listenForPublicLobbies() {
             if (unsubscribeLobbiesListener) unsubscribeLobbiesListener();
             const lobbiesQuery = query(collection(db, 'games'), where('status', '==', 'lobby'));
             unsubscribeLobbiesListener = onSnapshot(lobbiesQuery, (snapshot) => {
                 let lobbyHtml = '';
                 if (snapshot.empty) {
                     lobbyHtml = '<p class="text-gray-400 text-center">No active games. Create one!</p>';
                 } else {
                     snapshot.forEach(doc => {
                         const game = doc.data();
                         const playerCount = Object.keys(game.players).length;
                         lobbyHtml += `
                            <div class="flex justify-between items-center bg-gray-700 p-3 rounded">
                                <div>
                                    <p class="font-bold">Game by ${game.hostId.substring(0,5)}</p>
                                    <p class="text-sm">${playerCount}/4 Players</p>
                                </div>
                                <button data-game-id="${doc.id}" class="join-game-btn btn bg-green-600 text-white">Join</button>
                            </div>
                         `;
                     });
                 }
                 publicLobbiesContainer.innerHTML = lobbyHtml;
             });
        }
        
        document.addEventListener('click', e => {
            if(e.target.classList.contains('join-game-btn')) {
                joinGame(e.target.dataset.gameId);
            }
        });

        async function joinGame(gameId) {
             const gameDocRef = doc(db, 'games', gameId);
             const gameDoc = await getDoc(gameDocRef);
             if (!gameDoc.exists()) {
                 showToast("Game not found.");
                 return;
             }
             const gameData = gameDoc.data();
             if (Object.keys(gameData.players).length >= 4 && !gameData.players[currentUser.uid]) {
                 showToast("Game is full.");
                 return;
             }

             currentGameId = gameId;

             if(!gameData.players[currentUser.uid]) {
                await updateDoc(gameDocRef, {
                    [`players.${currentUser.uid}`]: {
                        username: `Player_${currentUser.uid.substring(0,5)}`,
                        balance: 2500,
                        hand: [], score: 0, bet: 0, status: 'betting'
                    }
                });
             }
             
             if (unsubscribeLobbiesListener) unsubscribeLobbiesListener();
             listenForGameUpdates(gameId);
             showView('game-view');
        }

        leaveGameBtn.addEventListener('click', async () => {
            if (!currentGameId || !currentUser) return;

            const gameDocRef = doc(db, 'games', currentGameId);
            const gameDoc = await getDoc(gameDocRef);

            if (gameDoc.exists()) {
                const gameData = gameDoc.data();
                const players = gameData.players;
                delete players[currentUser.uid];

                if (Object.keys(players).length === 0) {
                    await deleteDoc(gameDocRef);
                } else {
                     await updateDoc(gameDocRef, { players });
                }
            }

            if (unsubscribeGameListener) unsubscribeGameListener();
            currentGameId = null;
            showView('multiplayer-menu-view');
            listenForPublicLobbies();
        });


        // --- REAL-TIME GAME LOGIC & RENDERING ---
        function listenForGameUpdates(gameId) {
            if (unsubscribeGameListener) unsubscribeGameListener();
            const gameDocRef = doc(db, 'games', gameId);
            unsubscribeGameListener = onSnapshot(gameDocRef, (doc) => {
                if (!doc.exists()) {
                    // Game was deleted
                    showToast("The game has ended.");
                    if (unsubscribeGameListener) unsubscribeGameListener();
                    currentGameId = null;
                    showView('multiplayer-menu-view');
                    listenForPublicLobbies();
                    return;
                }
                const gameState = doc.data();
                renderGame(gameState);
            });
        }

        function renderGame(state) {
            const playerBoxContainer = document.querySelector('.multiplayer-area');
            const dealerCardsContainer = document.getElementById('dealer-cards-display');
            
            document.getElementById('game-id-display').textContent = currentGameId.substring(0,6);
            document.getElementById('game-status-display').textContent = state.gameMessage || '';

            // Render Dealer
            dealerCardsContainer.innerHTML = '';
            state.dealer.hand.forEach((card, index) => {
                const isHidden = index === 1 && !state.dealer.revealed;
                dealerCardsContainer.appendChild(createCardElement(card, isHidden));
            });
            document.getElementById('dealer-score-display').textContent = `= ${state.dealer.revealed ? calculateScore(state.dealer.hand) : getCardValue(state.dealer.hand[0]) || 0}`;

            // Render Players
            playerBoxContainer.innerHTML = '';
            for (const playerId in state.players) {
                const player = state.players[playerId];
                const isMe = playerId === currentUser.uid;
                const isMyTurn = state.currentPlayerTurn === playerId;
                
                const playerBox = document.createElement('div');
                playerBox.className = `player-box ${isMyTurn ? 'active-turn' : ''}`;
                playerBox.innerHTML = `
                    <h3 class="font-semibold text-lg">${player.username} ${isMe ? '(You)' : ''}</h3>
                    <p class="text-sm ${player.status === 'bust' ? 'text-red-500' : ''}">Score: ${player.score}</p>
                    <p class="text-sm text-yellow-400">Bet: $${player.bet}</p>
                    <div class="player-hand"></div>
                `;
                
                const handContainer = playerBox.querySelector('.player-hand');
                player.hand.forEach(card => {
                    handContainer.appendChild(createCardElement(card));
                });
                playerBoxContainer.appendChild(playerBox);

                if(isMe) {
                    document.getElementById('player-balance-display').textContent = `$${player.balance}`;
                    document.getElementById('current-bet-display').textContent = player.bet;
                }
            }
            // Update my controls based on state
             const myPlayerState = state.players[currentUser.uid];
             updateMyControls(state, myPlayerState);
        }

        function updateMyControls(gameState, myPlayerState) {
            if (!myPlayerState) return; // I might not be in the game state yet
            const isMyTurn = gameState.currentPlayerTurn === currentUser.uid;
            const canBet = myPlayerState.status === 'betting';
            
            document.getElementById('betting-controls').style.display = canBet ? 'block' : 'none';
            document.getElementById('action-controls').style.display = isMyTurn ? 'flex' : 'none';
        }
        
        function createCardElement(card, isHidden = false) {
             const cardEl = document.createElement('div');
             cardEl.className = 'card';

             cardEl.innerHTML = `
                <div class="card-face card-back"></div>
                <div class="card-face card-front ${['♥', '♦'].includes(card.suit) ? 'red' : ''}">
                    <div class="self-start"><span class="suit">${card.suit}</span> ${card.value}</div>
                    <div class="self-center text-4xl">${card.suit}</div>
                    <div class="self-end transform rotate-180"><span class="suit">${card.suit}</span> ${card.value}</div>
                </div>
             `;
             if (!isHidden) {
                 setTimeout(() => cardEl.classList.add('flipped'), 100);
             }
             return cardEl;
        }

        function calculateScore(cards) {
            let score = cards.reduce((sum, card) => sum + getCardValue(card), 0);
            let numAces = cards.filter(card => card.value === 'A').length;
            while (score > 21 && numAces > 0) {
                score -= 10;
                numAces--;
            }
            return score;
        }
        function getCardValue(card) {
            if (!card) return 0;
            if (['J', 'Q', 'K'].includes(card.value)) return 10;
            if (card.value === 'A') return 11;
            return parseInt(card.value);
        }

        // --- TODO: Single player logic needs to be wired up here ---
        document.getElementById('single-player-btn').addEventListener('click', () => {
            showToast("Single player mode coming soon!");
        });

    </script>
</body>
</html>

